# Feature: AI-Powered Recipe Search

## Context

Users need a way to search for recipes based on available ingredients and dietary restrictions. The system will build a prompt, check an in-memory cache, and call the Claude API (Haiku 4.5) on cache miss. This feature also serves as an educational showcase for additional Kotlin coroutine patterns: **Ktor HTTP Client**, **`withTimeout`**, **`Mutex`**, and **`Semaphore`**.

## New Coroutine Patterns

| Pattern                    | Where                      | Why                                                                          |
|----------------------------|----------------------------|------------------------------------------------------------------------------|
| Ktor HTTP Client (suspend) | ClaudeClientImplementation | Suspend-based external HTTP calls                                            |
| `withTimeout`              | ClaudeClientImplementation | Hard deadline on API calls (throws, vs `withTimeoutOrNull` in HealthService) |
| `Mutex` (per-key)          | RecipeCache                | Prevents cache stampede via double-check locking                             |
| `Semaphore`                | ClaudeClientImplementation | Rate-limits concurrent API calls to Claude                                   |

## Architecture

```
RecipeRoutes (POST /recipes/search, JWT protected)
  └── RecipeService (concrete class: prompt building, cache orchestration)
        ├── RecipeCache (concrete class: Caffeine + per-key Mutex)
        └── ClaudeClient (interface — 3rd party integration)
              └── ClaudeClientImplementation (Ktor HTTP Client + Semaphore + withTimeout)
```

---

## Step 1: Dependencies + OpenAPI Spec

**Modify:** `pom.xml`

```xml
<!-- Ktor HTTP Client -->
<dependency>
    <groupId>io.ktor</groupId>
    <artifactId>ktor-client-cio-jvm</artifactId>
    <version>${ktor.version}</version>
</dependency>

<!-- Caffeine Cache -->
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>3.1.8</version>
</dependency>

<!-- Ktor Client Mock (test only) -->
<dependency>
    <groupId>io.ktor</groupId>
    <artifactId>ktor-client-mock-jvm</artifactId>
    <version>${ktor.version}</version>
    <scope>test</scope>
</dependency>
```

Also: remove `<scope>test</scope>` from existing `ktor-client-content-negotiation-jvm` entry (needed at runtime for the HTTP client JSON serialization).

**Modify:** `src/main/resources/openapi.yaml`

- Add `Recipes` tag
- Add `POST /recipes/search` path (JWT protected via `bearerAuth`)
- Add schemas:
  - `RecipeSearchRequest`: `ingredients` (required, `List<String>`), `dietary_restrictions` (optional, `List<String>`)
  - `RecipeResponse`: `title`, `ingredients`, `instructions`, `preparation_time`, `servings`, `cached`

Models are auto-generated by openapi-generator-maven-plugin.

**Verify:** `mvn compile` — check `target/generated-sources/openapi/src/main/kotlin/models/dto/RecipeSearchRequest.kt` and `RecipeResponse.kt` exist.

---

## Step 2: ClaudeClient Interface + Implementation + Tests

**Create:** `src/main/kotlin/services/ClaudeClient.kt` — interface (per convention: 3rd party integration)
```kotlin
interface ClaudeClient {
    suspend fun generateRecipe(prompt: String): String
}
```

**Create:** `src/main/kotlin/services/ClaudeClientImplementation.kt`
- Ktor `HttpClient(CIO)` with `ContentNegotiation` for JSON
- `Semaphore(maxConcurrentRequests = 5)` — rate-limits concurrent API calls (suspends, doesn't block)
- `withTimeout(30_000)` — hard deadline on the HTTP call
- POST to `https://api.anthropic.com/v1/messages` with headers `x-api-key`, `anthropic-version: 2023-06-01`
- Model: `claude-haiku-4-5-20251001`
- API key from `System.getenv("ANTHROPIC_API_KEY")`
- Internal serializable DTOs: `ClaudeRequest`, `ClaudeMessage`, `ClaudeResponse`, `ClaudeContentBlock`

**Create:** `src/test/kotlin/services/ClaudeClientTest.kt`
- `FakeClaudeClient` implementing `ClaudeClient` (reusable in other tests) — tracks `lastPrompt`, `callCount`
- Test: fake client returns expected text
- Test: `withTimeout` throws `TimeoutCancellationException` when mock engine delays beyond deadline
- Test: `Semaphore` limits concurrent requests (launch 5 concurrent calls with `maxConcurrentRequests=2`, verify `AtomicInteger` max concurrency <= 2)

Uses `ktor-client-mock-jvm` (added in Step 1).

**Verify:** `mvn test`

---

## Step 3: RecipeCache + Tests

**Create:** `src/main/kotlin/services/RecipeCache.kt`
- `Caffeine.newBuilder().maximumSize(1000).expireAfterWrite(60, MINUTES).build<String, String>()`
- `ConcurrentHashMap<String, Mutex>` for per-key locks
- `get(key)` / `put(key, value)` — simple non-suspend wrappers
- `getOrCompute(key, compute: suspend () -> String)` — double-check locking:
  1. Check cache (fast path, no lock)
  2. Acquire per-key `Mutex`
  3. Check cache again inside lock
  4. If still missing, call `compute()`, store result

**Create:** `src/test/kotlin/services/RecipeCacheTest.kt`
- Test: `get` returns null for missing key
- Test: `put`/`get` round-trip
- Test: `getOrCompute` returns cached value without calling compute
- Test: `getOrCompute` calls compute on cache miss
- Test: **stampede prevention** — 10 concurrent `getOrCompute` for same key with `delay` in compute → compute called exactly once
- Test: parallel computation allowed for different keys

**Verify:** `mvn test`

---

## Step 4: RecipeService + Tests

**Create:** `src/main/kotlin/services/RecipeService.kt`
- Constructor takes `ClaudeClient` and `RecipeCache`
- `searchRecipe(ingredients, dietaryRestrictions)`:
  - Validates non-empty ingredients (throws `ValidationException`)
  - Builds cache key (normalized: lowercase, sorted)
  - Checks cache → if hit, return with `cached=true`
  - On miss, `recipeCache.getOrCompute(key) { claudeClient.generateRecipe(prompt) }`
  - Returns `RecipeResponse` with `cached=false`
- `buildPrompt()` — instructs Claude to return JSON with title, ingredients, instructions, preparation_time, servings
- `parseRecipeResponse()` — parses JSON, strips markdown code fences, falls back gracefully on parse errors

**Create:** `src/test/kotlin/services/RecipeServiceTest.kt`
- Uses `FakeClaudeClient` from Step 2
- Test: throws `ValidationException` for empty ingredients
- Test: `buildCacheKey` normalizes and sorts (["Rice","chicken"] == ["chicken","rice"])
- Test: `buildPrompt` includes ingredients and restrictions
- Test: returns parsed `RecipeResponse` from fake Claude JSON
- Test: `cached=false` on first call, `cached=true` on second (same ingredients)
- Test: handles non-JSON Claude response gracefully (fallback parsing)

**Verify:** `mvn test`

---

## Step 5: RecipeRoutes + Wiring + StatusPages + Integration Tests

**Create:** `src/main/kotlin/routes/RecipeRoutes.kt`
```kotlin
fun Route.configureRecipeRoutes(recipeService: RecipeService) {
    route("/recipes") {
        authenticate("auth-jwt") {
            post("/search") { ... }
        }
    }
}
```

**Modify:** `src/main/kotlin/WhatToEat.kt`
- Instantiate `ClaudeClientImplementation`, `RecipeCache`, `RecipeService`
- Add `configureRecipeRoutes(recipeService)` to routing block
- Add `configureRouting(claudeClient: ClaudeClient? = null)` overload for test injection
- Add `testModule(claudeClient: ClaudeClient)` for integration tests

**Modify:** `src/main/kotlin/plugins/StatusPagesPlugin.kt`
- Add `TimeoutCancellationException` → 504 Gateway Timeout handler

**Create:** `src/test/kotlin/routes/RecipeRoutesTest.kt`
- Uses `testModule(FakeClaudeClient())` for test isolation
- Test: returns 401 without JWT token
- Test: returns 400 for empty ingredients
- Test: returns 200 with valid token + ingredients, response has `title` field
- Test: second request returns `cached=true`

**Verify:** `mvn test`

---

## Step 6: Documentation

- Update `README.md` — add endpoint to API table, add new coroutine patterns to table, add Caffeine to tech stack

**Verify:** `mvn test` — all tests still pass.

---

## Files Summary

**Create (5 source + 4 test):**
- `src/main/kotlin/services/ClaudeClient.kt`
- `src/main/kotlin/services/ClaudeClientImplementation.kt`
- `src/main/kotlin/services/RecipeCache.kt`
- `src/main/kotlin/services/RecipeService.kt`
- `src/main/kotlin/routes/RecipeRoutes.kt`
- `src/test/kotlin/services/ClaudeClientTest.kt` (includes `FakeClaudeClient`)
- `src/test/kotlin/services/RecipeCacheTest.kt`
- `src/test/kotlin/services/RecipeServiceTest.kt`
- `src/test/kotlin/routes/RecipeRoutesTest.kt`

**Modify (5):**
- `pom.xml` — 3 new deps + scope change
- `src/main/resources/openapi.yaml` — new endpoint + schemas
- `src/main/kotlin/WhatToEat.kt` — wire recipe dependencies + testModule
- `src/main/kotlin/plugins/StatusPagesPlugin.kt` — TimeoutCancellationException handler
- `README.md` — new endpoint + patterns